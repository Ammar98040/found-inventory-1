<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</title>
    {% load static %}
    <link rel="icon" type="image/svg+xml" href="{% static 'img/favicon.svg' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/product_buttons.css' %}">
    <style>
        .backup-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
        }
        .backup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            color: white;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-right: 3px solid #667eea;
        }
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .action-card {
            padding: 25px;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .action-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }
        .action-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
        }
        .upload-area:hover {
            border-color: var(--primary-color);
            background: #f1f5f9;
        }
        .upload-area.dragover {
            border-color: var(--primary-color);
            background: #eef2ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="backup-header">
            <h1>ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Ø§Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¹Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø£Ù…Ø§Ù† ØªØ§Ù…</p>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        <div class="backup-section">
            <h2 style="margin-bottom: 20px; color: var(--primary-color);">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø´Ø§Ù…Ù„)</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</div>
                    <div class="stat-value">{{ stats.warehouses }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</div>
                    <div class="stat-value">{{ stats.locations }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                    <div class="stat-value">{{ stats.products }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                    <div class="stat-value">{{ stats.audit_logs }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                    <div class="stat-value">{{ stats.orders }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</div>
                    <div class="stat-value">{{ stats.returns }}</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                    <div class="stat-value">{{ stats.user_profiles }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ø³Ø¬Ù„Ø§Øª Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                    <div class="stat-value">{{ stats.user_activity_logs }}</div>
                </div>
            </div>
        </div>

        <!-- ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
        <div class="backup-section">
            <div class="action-card">
                <div class="action-icon">ğŸ“¤</div>
                <h3 style="margin-bottom: 15px;">ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Ù‚Ù… Ø¨ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© <strong>Ø´Ø§Ù…Ù„Ø© ÙˆÙƒØ§Ù…Ù„Ø©</strong> Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ØªØ´Ù…Ù„:
                    <br>â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£Ù…Ø§ÙƒÙ† ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
                    <br>â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°ÙØŒ Ø³Ø­Ø¨ØŒ Ø¥Ø±Ø¬Ø§Ø¹)
                    <br>â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
                    <br>â€¢ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    <br>â€¢ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    <br><br>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.
                </p>
                <button onclick="exportBackup()" class="btn btn--sm btn--success">
                    <span class="icon">ğŸ“¥</span>
                    <span>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
                </button>
            </div>
        </div>

        <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
        <div class="backup-section">
            <div class="action-card">
                <div class="action-icon">ğŸ“¥</div>
                <h3 style="margin-bottom: 15px;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.
                </p>
                <!-- Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹ -->
                
                <div class="upload-area" id="upload-area" onclick="document.getElementById('backup-file-input').click()">
                    <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
                    <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: .json</div>
                </div>
                
                <input type="file" id="backup-file-input" accept=".json,.zip" style="display: none;" onchange="handleFileSelect(this)">
                
                <div style="margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="clear-existing" style="width: 18px; height: 18px;">
                        <span>Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top:8px;">
                        <input type="checkbox" id="avoid-duplicates" style="width: 18px; height: 18px;" checked>
                        <span>Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØªØ®Ø·ÙŠ Ø§Ù„Ù…ÙƒØ±Ø±Ø©</span>
                    </label>
                    <button class="btn btn--sm btn--danger" style="margin-top:10px;" onclick="resetEnvironment()">
                        <span class="icon">ğŸ—‘ï¸</span>
                        <span>ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ¦Ø© Ù†Ø¸ÙŠÙØ© (Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</span>
                    </button>
                </div>

                <div id="sections-container" style="margin-top: 15px; display:none;"></div>
                
                <button onclick="importBackup()" class="btn btn--sm btn--success" style="margin-top: 15px; display:none;" id="import-btn" disabled>
                    <span class="icon">ğŸ”„</span>
                    <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
                </button>
            </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù…Ø© -->
        <div class="backup-section" style="background: #fef3c7; border-right: 4px solid #f59e0b;">
            <h3 style="color: #92400e; margin-bottom: 15px;">âš ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù…Ø©</h3>
            <ul style="color: #78350f; line-height: 1.8;">
                <li>ÙŠÙÙ†ØµØ­ Ø¨Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø§Ù†ØªØ¸Ø§Ù… Ù„Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</li>
                <li>ÙŠØ­ØªÙØ¸ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§ØªØŒ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†ØŒ Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª</li>
                <li>Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¹ "Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©"ØŒ Ø³ÙŠØªÙ… Ù…Ø­Ùˆ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</li>
                <li>Ø§Ø­ØªÙØ¸ Ø¨Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†</li>
                <li>ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</li>
            </ul>
        </div>
    </div>

    <!-- Sidebar -->
    <button id="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
    
    <div id="sidebar-overlay"></div>
    
    <div id="main-sidebar">
        <div class="sidebar-header">
            <h2>ğŸ§­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</h2>
            <button class="sidebar-close" onclick="toggleSidebar()">Ã—</button>
        </div>
        
        <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« -->
        <div class="sidebar-search">
            <input type="text" id="sidebar-search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…..." autocomplete="off">
            <div id="sidebar-search-results"></div>
        </div>
        
        <div class="sidebar-content" id="sidebar-main-content">
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                <a href="/" class="sidebar-link">
                    <span class="icon">ğŸ”</span>
                    <span class="text">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                </a>
                <a href="/dashboard/" class="sidebar-link">
                    <span class="icon">ğŸ“Š</span>
                    <span class="text">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                <a href="/products/" class="sidebar-link">
                    <span class="icon">ğŸ“¦</span>
                    <span class="text">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                </a>
                <a href="/products/add/" class="sidebar-link">
                    <span class="icon">â•</span>
                    <span class="text">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</div>
                <a href="/manage/" class="sidebar-link">
                    <span class="icon">âš™ï¸</span>
                    <span class="text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</span>
                </a>
                <a href="/locations/" class="sidebar-link">
                    <span class="icon">ğŸ“</span>
                    <span class="text">Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                <a href="/audit-logs/" class="sidebar-link">
                    <span class="icon">ğŸ“‹</span>
                    <span class="text">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                </a>
            </div>
            
            
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
                <a href="/backup-restore/" class="sidebar-link active">
                    <span class="icon">ğŸ’¾</span>
                    <span class="text">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
                </a>
                <a href="/merge-files/" class="sidebar-link">
                    <span class="icon">ğŸ§©</span>
                    <span class="text">Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª</span>
                </a>
                <a href="/data-deletion/" class="sidebar-link">
                    <span class="icon">ğŸ—‘ï¸</span>
                    <span class="text">Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                </a>
                <a href="/inventory-insights/" class="sidebar-link">
                    <span class="icon">ğŸ“¦</span>
                    <span class="text">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</div>
                <div class="stats-container">
                    <div class="stat-category">
                        <div class="stat-category-title">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                        <div class="stat-item">
                            <div class="stat-icon">ğŸ“¦</div>
                            <div class="stat-info">
                                <div class="stat-value" id="stats-products">-</div>
                                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-category">
                        <div class="stat-category-title">ğŸ“ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</div>
                        <div class="stat-item">
                            <div class="stat-icon">ğŸ“Š</div>
                            <div class="stat-info">
                                <div class="stat-value" id="stats-capacity">-</div>
                                <div class="stat-label">Ø§Ù„Ø³Ø¹Ø©</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/sidebar.js' %}"></script>
    <script src="{% static 'js/auto_refresh.js' %}"></script>
    
    <script>
        let selectedFile = null;

        function exportBackup() {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØŸ')) {
                return;
            }
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/api/export-backup/';
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                const token = document.createElement('input');
                token.type = 'hidden';
                token.name = 'csrfmiddlewaretoken';
                token.value = '{{ csrf_token }}';
                form.appendChild(token);
            }
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedFile = input.files[0];
                
                // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
                const uploadArea = document.getElementById('upload-area');
                uploadArea.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“¦</div>
                    <div style="font-weight: bold; color: #0ea5e9;">${selectedFile.name}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px;">${(selectedFile.size / 1024).toFixed(2)} KB</div>
                    <div style="margin-top:10px; color:#6b7280;">ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø§Ù„Ø¢Ù†...</div>
                `;
                document.getElementById('import-btn').disabled = false;
                importBackup();
                return;
                
                // Ù‚Ø±Ø§Ø¡Ø© ÙˆÙ…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø³Ø®Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                const reader = new FileReader();
                reader.onload = function() {
                    try {
                        let text = reader.result;
                        if (text && text.charCodeAt(0) === 0xFEFF) {
                            text = text.slice(1);
                        }
                        const data = JSON.parse(text);
                        const availableKeys = Object.keys(data).filter(k => Array.isArray(data[k]));
                        const keyLabels = {
                            warehouses: 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª',
                            locations: 'Ø§Ù„Ø£Ù…Ø§ÙƒÙ†',
                            products: 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
                            orders: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                            returns: 'Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª',
                            audit_logs: 'Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
                            user_profiles: 'Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
                            user_activity_logs: 'Ø³Ø¬Ù„Ø§Øª Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'
                        };
                        let html = '<div style="margin-top:10px; font-weight:bold;">Ø§Ø®ØªØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§:</div>';
                        html += '<div style="display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-top:10px;">';
                        availableKeys.forEach(k => {
                            const label = keyLabels[k] || k;
                            const count = Array.isArray(data[k]) ? data[k].length : 0;
                            const preChecked = Array.from(document.querySelectorAll('.pre-section-checkbox')).some(cb => cb.value === k && cb.checked);
                            const checked = preChecked;
                            html += `
                                <label style="display:flex; align-items:center; gap:8px;">
                                    <input type="checkbox" class="section-checkbox" value="${k}" ${checked ? 'checked' : ''}>
                                    <span>${label} (<span style="color:#6b7280;">${count}</span>)</span>
                                </label>
                            `;
                        });
                        html += '</div>';
                        document.getElementById('sections-container').innerHTML = html;
                        document.getElementById('import-btn').disabled = false;
                        const fd = new FormData();
                        fd.append('backup_file', selectedFile);
                        fetch('/api/inspect-backup/', { method: 'POST', body: fd, credentials: 'same-origin' })
                          .then(r => r.json())
                          .then(info => {
                            if (!info.success) {
                              document.getElementById('sections-container').innerHTML = `<div style="color:#b91c1c;">âŒ ${info.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„'}</div>`;
                              document.getElementById('import-btn').disabled = true;
                              return;
                            }
                            let meta = '';
                            if (info.parse_meta) {
                              const enc = info.parse_meta.encoding || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                              const src = info.parse_meta.source || 'raw';
                              const fixes = (info.parse_meta.fixes||[]).join(', ');
                              meta = `<div style="margin-top:8px; color:#6b7280; font-size:0.9rem;">Ø§Ù„ØªØ±Ù…ÙŠØ²: <strong>${enc}</strong> | Ø§Ù„Ù…ØµØ¯Ø±: ${src} | Ø¥ØµÙ„Ø§Ø­Ø§Øª: ${fixes}</div>`;
                            }
                            let extra = '';
                            if (info.product_duplicates && info.product_duplicates.length) {
                              extra += '<div style="margin-top:10px; background:#fff7ed; border-right:4px solid #f59e0b; padding:8px; border-radius:6px;">';
                              extra += '<div style="color:#92400e; font-weight:bold; margin-bottom:6px;">ØªØ¹Ø§Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:</div>';
                              extra += '<ul style="color:#78350f;">';
                              info.product_duplicates.slice(0,20).forEach(row => {
                                extra += `<li>${row.product_number} â†’ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… (${row.existing_name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'})ØŒ Ù…ÙƒØ±Ø± Ø¨Ø§Ù„Ù…Ù„Ù ${row.count_in_backup} Ù…Ø±Ø©</li>`;
                              });
                              extra += '</ul></div>';
                            }
                            if (extra || meta) {
                              document.getElementById('sections-container').innerHTML += meta + extra;
                            }
                          })
                          .catch(()=>{});
                    } catch (e) {
                        try {
                            // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ€ ArrayBuffer Ø«Ù… ÙÙƒ ØªØ±Ù…ÙŠØ² UTF-8 ÙŠØ¯ÙˆÙŠØ§Ù‹
                            const reader2 = new FileReader();
                            reader2.onload = function() {
                                try {
                                    const decoder = new TextDecoder('utf-8');
                                    let text2 = decoder.decode(reader2.result);
                                    if (text2 && text2.charCodeAt(0) === 0xFEFF) {
                                        text2 = text2.slice(1);
                                    }
                                    const data2 = JSON.parse(text2);
                                    const availableKeys = Object.keys(data2).filter(k => Array.isArray(data2[k]));
                                    const keyLabels = {
                                        warehouses: 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª',
                                        locations: 'Ø§Ù„Ø£Ù…Ø§ÙƒÙ†',
                                        products: 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
                                        orders: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                                        returns: 'Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª',
                                        audit_logs: 'Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
                                        user_profiles: 'Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
                                        user_activity_logs: 'Ø³Ø¬Ù„Ø§Øª Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'
                                    };
                                    let html = '<div style="margin-top:10px; font-weight:bold;">Ø§Ø®ØªØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§:</div>';
                                    html += '<div style="display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-top:10px;">';
                                    availableKeys.forEach(k => {
                                        const label = keyLabels[k] || k;
                                        const count = Array.isArray(data2[k]) ? data2[k].length : 0;
                                        const checked = (k === 'warehouses' || k === 'locations' || k === 'products' || k === 'orders' || k === 'audit_logs' || k === 'returns');
                                        html += `
                                            <label style="display:flex; align-items:center; gap:8px;">
                                                <input type="checkbox" class="section-checkbox" value="${k}" ${checked ? 'checked' : ''}>
                                                <span>${label} (<span style="color:#6b7280;">${count}</span>)</span>
                                            </label>
                                        `;
                                    });
                                    html += '</div>';
                                    document.getElementById('sections-container').innerHTML = html;
                                    document.getElementById('import-btn').disabled = false;
                                    const fd = new FormData();
                                    fd.append('backup_file', selectedFile);
                                    fetch('/api/inspect-backup/', { method: 'POST', body: fd, credentials: 'same-origin' })
                                      .then(r => r.json())
                                      .then(info => {
                                        if (!info.success) {
                                          document.getElementById('sections-container').innerHTML = `<div style=\"color:#b91c1c;\">âŒ ${info.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„'}</div>`;
                                          document.getElementById('import-btn').disabled = true;
                                          return;
                                        }
                                        let meta = '';
                                        if (info.parse_meta) {
                                          const enc = info.parse_meta.encoding || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                          const src = info.parse_meta.source || 'raw';
                                          const fixes = (info.parse_meta.fixes||[]).join(', ');
                                          meta = `<div style=\"margin-top:8px; color:#6b7280; font-size:0.9rem;\">Ø§Ù„ØªØ±Ù…ÙŠØ²: <strong>${enc}</strong> | Ø§Ù„Ù…ØµØ¯Ø±: ${src} | Ø¥ØµÙ„Ø§Ø­Ø§Øª: ${fixes}</div>`;
                                        }
                                        let extra = '';
                                        if (info.product_duplicates && info.product_duplicates.length) {
                                          extra += '<div style="margin-top:10px; background:#fff7ed; border-right:4px solid #f59e0b; padding:8px; border-radius:6px;">';
                                          extra += '<div style="color:#92400e; font-weight:bold; margin-bottom:6px;">ØªØ¹Ø§Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:</div>';
                                          extra += '<ul style="color:#78350f;">';
                                          info.product_duplicates.slice(0,20).forEach(row => {
                                            extra += `<li>${row.product_number} â†’ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… (${row.existing_name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'})ØŒ Ù…ÙƒØ±Ø± Ø¨Ø§Ù„Ù…Ù„Ù ${row.count_in_backup} Ù…Ø±Ø©</li>`;
                                          });
                                          extra += '</ul></div>';
                                        }
                                        if (extra || meta) {
                                          document.getElementById('sections-container').innerHTML += meta + extra;
                                        }
                                      })
                                      .catch(()=>{});
                                } catch (e2) {
                                    document.getElementById('sections-container').innerHTML = '<div style="color:#b91c1c;">ØªØ¹Ø°Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„ÙØŒ Ø³ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…</div>';
                                    document.getElementById('import-btn').disabled = false;
                                    const fd = new FormData();
                                    fd.append('backup_file', selectedFile);
                                    fetch('/api/inspect-backup/', { method: 'POST', body: fd, credentials: 'same-origin' })
                                      .then(r => r.json())
                                      .then(info => {
                                        if (!info.success) return;
                                        let extra = '';
                                        if (info.product_duplicates && info.product_duplicates.length) {
                                          extra += '<div style="margin-top:10px; background:#fff7ed; border-right:4px solid #f59e0b; padding:8px; border-radius:6px;">';
                                          extra += '<div style="color:#92400e; font-weight:bold; margin-bottom:6px;">ØªØ¹Ø§Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:</div>';
                                          extra += '<ul style="color:#78350f;">';
                                          info.product_duplicates.slice(0,20).forEach(row => {
                                            extra += `<li>${row.product_number} â†’ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… (${row.existing_name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'})ØŒ Ù…ÙƒØ±Ø± Ø¨Ø§Ù„Ù…Ù„Ù ${row.count_in_backup} Ù…Ø±Ø©</li>`;
                                          });
                                          extra += '</ul></div>';
                                        }
                                        if (extra) {
                                          document.getElementById('sections-container').innerHTML += extra;
                                        }
                                      })
                                      .catch(()=>{});
                                }
                            };
                            reader2.readAsArrayBuffer(selectedFile);
                        } catch (e3) {
                            document.getElementById('sections-container').innerHTML = '<div style="color:#b91c1c;">ØªØ¹Ø°Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„ÙØŒ Ø³ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…</div>';
                            document.getElementById('import-btn').disabled = false;
                            const fd = new FormData();
                            fd.append('backup_file', selectedFile);
                            fetch('/api/inspect-backup/', { method: 'POST', body: fd, credentials: 'same-origin' })
                              .then(r => r.json())
                              .then(info => {
                                if (!info.success) {
                                  document.getElementById('sections-container').innerHTML = `<div style=\"color:#b91c1c;\">âŒ ${info.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„'}</div>`;
                                  document.getElementById('import-btn').disabled = true;
                                  return;
                                }
                                let meta = '';
                                if (info.parse_meta) {
                                  const enc = info.parse_meta.encoding || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                  const src = info.parse_meta.source || 'raw';
                                  const fixes = (info.parse_meta.fixes||[]).join(', ');
                                  meta = `<div style=\"margin-top:8px; color:#6b7280; font-size:0.9rem;\">Ø§Ù„ØªØ±Ù…ÙŠØ²: <strong>${enc}</strong> | Ø§Ù„Ù…ØµØ¯Ø±: ${src} | Ø¥ØµÙ„Ø§Ø­Ø§Øª: ${fixes}</div>`;
                                }
                                let extra = '';
                                if (info.product_duplicates && info.product_duplicates.length) {
                                  extra += '<div style="margin-top:10px; background:#fff7ed; border-right:4px solid #f59e0b; padding:8px; border-radius:6px;">';
                                  extra += '<div style="color:#92400e; font-weight:bold; margin-bottom:6px;">ØªØ¹Ø§Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:</div>';
                                  extra += '<ul style="color:#78350f;">';
                                  info.product_duplicates.slice(0,20).forEach(row => {
                                    extra += `<li>${row.product_number} â†’ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… (${row.existing_name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'})ØŒ Ù…ÙƒØ±Ø± Ø¨Ø§Ù„Ù…Ù„Ù ${row.count_in_backup} Ù…Ø±Ø©</li>`;
                                  });
                                  extra += '</ul></div>';
                                }
                                if (extra || meta) {
                                  document.getElementById('sections-container').innerHTML += meta + extra;
                                }
                              })
                              .catch(()=>{});
                        }
                    }
                };
                reader.readAsText(selectedFile);
            }
        }

        function importBackup() {
            if (!selectedFile) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ');
                return;
            }
            
            const clearExisting = document.getElementById('clear-existing').checked;
            
            const formData = new FormData();
            formData.append('backup_file', selectedFile);
            formData.append('clear_existing', clearExisting);
            const avoidDuplicates = document.getElementById('avoid-duplicates').checked;
            formData.append('avoid_duplicates', avoidDuplicates);
            const selectedSections = Array.from(document.querySelectorAll('.section-checkbox'))
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            if (selectedSections.length === 0) {
                const preSelected = Array.from(document.querySelectorAll('.pre-section-checkbox'))
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                preSelected.length > 0 && formData.append('selected_sections', JSON.stringify(preSelected));
            } else {
                const preSelected = Array.from(document.querySelectorAll('.pre-section-checkbox'))
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                const finalSelected = preSelected.length > 0 ? selectedSections.filter(k => preSelected.includes(k)) : selectedSections;
                formData.append('selected_sections', JSON.stringify(finalSelected));
            }
            
            // Ø¥Ø¶Ø§ÙØ© CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken.value);
            } else {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ù…Ù† cookies
                const cookieValue = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('csrftoken='))
                    ?.split('=')[1];
                if (cookieValue) {
                    formData.append('csrfmiddlewaretoken', cookieValue);
                }
            }
            
            fetch('/api/import-backup/', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(async (response) => {
                if (response.redirected || (response.status >= 300 && response.status < 400)) {
                    throw new Error('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨');
                }
                const ct = response.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    const txt = await response.text();
                    const msg = txt.startsWith('<!DOCTYPE') ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª' : (txt || 'Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
                    throw new Error(msg);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const imported = data.imported ? JSON.stringify(data.imported) : '';
                    alert('âœ… ' + data.message + (imported ? '\n' + imported : ''));
                    window.location.reload();
                } else {
                    const details = Array.isArray(data.details) ? '\n- ' + data.details.slice(0,10).join('\n- ') : '';
                    alert('âŒ ' + (data.error || 'ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯') + details);
                }
            })
            .catch(error => {
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            });
        }

        function resetEnvironment() {
            if (!confirm('âš ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ù†Ø¸ÙŠÙØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            fetch('/api/reset-environment/', { method: 'POST', credentials: 'same-origin' })
              .then(async (response) => {
                const ct = response.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    const txt = await response.text();
                    throw new Error(txt || 'Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
                }
                return response.json();
              })
              .then(data => {
                if (data.success) {
                    alert('âœ… ' + data.message);
                    window.location.reload();
                } else {
                    alert('âŒ ' + (data.error || 'ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©'));
                }
              })
              .catch(err => alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err.message));
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById('upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('backup-file-input').files = files;
                handleFileSelect(document.getElementById('backup-file-input'));
            }
        });
    </script>
</body>
</html>
