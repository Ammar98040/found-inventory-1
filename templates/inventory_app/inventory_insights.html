<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/notifications.css' %}">
    <style>
        body{background:linear-gradient(135deg,#f8fafc 0%,#eef2ff 100%)}
        .header{background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);color:#fff;padding:18px;border-radius:12px;box-shadow:var(--shadow-lg)}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin:16px 0}
        .stat{color:#0f172a;border-radius:12px;box-shadow:var(--shadow-lg);padding:16px;font-weight:700}
        .stat.reorder{background:linear-gradient(135deg,#dcfce7 0%,#86efac 100%)}
        .stat.overstock{background:linear-gradient(135deg,#fee2e2 0%,#fca5a5 100%)}
        .stat.watch{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%)}
        .section{border-radius:12px;box-shadow:var(--shadow-lg);padding:16px;margin-bottom:16px;color:#0f172a}
        .section.reorder{background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%)}
        .section.overstock{background:linear-gradient(135deg,#fff7ed 0%,#fee2e2 100%)}
        .section.watch{background:linear-gradient(135deg,#fffbeb 0%,#fef3c7 100%)}
        .items{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
        .item{background:#ffffffcc;border-radius:8px;padding:10px}
        .badge{display:inline-block;background:#1e293b;color:#fff;border-radius:999px;padding:4px 10px;font-size:.85rem}
        .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
        .btn{background:#1e293b;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
        .btn.secondary{background:#f1f5f9;color:#0f172a}
        input[type="number"]{padding:8px;border:2px solid #e2e8f0;border-radius:8px;width:120px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <h1 style="margin:0">ğŸ“¦ ØªÙˆØµÙŠØ§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØªÙˆØ§Ø²Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h1>
            <div class="controls">
                <label>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ÙØ§Ø¦Ø¶:</label>
                <input id="multiplier-input" type="number" min="1" value="{{ multiplier }}">
                <a id="apply-multiplier" class="btn secondary" href="?overstock_multiplier={{ multiplier }}">ØªØ·Ø¨ÙŠÙ‚</a>
            </div>
        </div>

        <div class="section watch" style="margin-top:10px">
            <div style="font-weight:700; margin-bottom:8px;">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù‚ÙŠÙ…</div>
            <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                <span class="badge">Ù…Ù†Ø®ÙØ¶ Ø¹Ø§Ù… â‰¤ {{ policy.low_stock_limit }}</span>
                <span class="badge">Ù…Ø¹Ø§Ù…Ù„ ÙØ§Ø¦Ø¶ Ã— {{ policy.overstock_multiplier }}</span>
                <span class="badge">Ù‡Ø§Ù…Ø´ Ù…ØªØ§Ø¨Ø¹Ø© Â± {{ policy.watchlist_margin_percent }}%</span>
                <span class="badge">ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ± â‰¥ {{ policy.large_change_threshold }}</span>
                <span class="badge">ØªÙƒØ±Ø§Ø± ØªØºÙŠÙŠØ±Ø§Øª Ø®Ù„Ø§Ù„ {{ policy.frequent_window_hours }} Ø³Ø§Ø¹Ø© â‰¥ {{ policy.frequent_change_min_count }}</span>
            </div>
        </div>

        <div class="stats">
            <div class="stat reorder">ØªÙˆØµÙŠØ§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨<br><span style="font-weight:600;opacity:.8">{{ counts.reorder }}</span></div>
            <div class="stat overstock">ÙØ§Ø¦Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†<br><span style="font-weight:600;opacity:.8">{{ counts.overstock }}</span></div>
            <div class="stat watch">Ù‚Ø§Ø¦Ù…Ø© Ù…ØªØ§Ø¨Ø¹Ø©<br><span style="font-weight:600;opacity:.8">{{ counts.watchlist }}</span></div>
            <div class="stat watch">Ù…Ù†Ø®ÙØ¶ Ø¹Ø§Ù… (â‰¤ {{ policy.low_stock_limit }})<br><span style="font-weight:600;opacity:.8">{{ counts.low_general }}</span></div>
            <div class="stat overstock">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø´Ø°ÙˆØ°<br><span style="font-weight:600;opacity:.8">{{ counts.anomaly }}</span></div>
        </div>

        {% if reorder_suggestions %}
        <div class="section reorder">
            <h2>ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨</h2>
            <div class="items">
                {% for s in reorder_suggestions %}
                    <div class="item">
                        <div><strong>Ø±Ù‚Ù…:</strong> {{ s.product.product_number }}</div>
                        <div><strong>Ø§Ø³Ù…:</strong> {{ s.product.name }}</div>
                        <div><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> {{ s.product.quantity }}</div>
                        <div><strong>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰:</strong> {{ s.product.min_stock_threshold }}</div>
                        <div><strong>Ø§Ù‚ØªØ±Ø­ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨:</strong> <span class="badge">{{ s.reorder_qty }}</span></div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if general_low_stock %}
        <div class="section watch">
            <h2>âš ï¸ Ù…Ù†ØªØ¬Ø§Øª Ø£Ù‚Ù„ Ù…Ù† {{ policy.low_stock_limit }} Ø­Ø¨Ø©</h2>
            <div class="items">
                {% for p in general_low_stock %}
                    <div class="item">
                        <div><strong>Ø±Ù‚Ù…:</strong> {{ p.product_number }}</div>
                        <div><strong>Ø§Ø³Ù…:</strong> {{ p.name }}</div>
                        <div><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> {{ p.quantity }}</div>
                        <a href="/products/{{ p.id }}/" class="btn" style="margin-top:8px">ÙØªØ­ Ø§Ù„Ù…Ù†ØªØ¬</a>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if overstock_items %}
        <div class="section overstock">
            <h2>ğŸ“ˆ ÙØ§Ø¦Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
            <div class="items">
                {% for o in overstock_items %}
                    <div class="item">
                        <div><strong>Ø±Ù‚Ù…:</strong> {{ o.product.product_number }}</div>
                        <div><strong>Ø§Ø³Ù…:</strong> {{ o.product.name }}</div>
                        <div><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> {{ o.warehouse }}</div>
                        <div><strong>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰:</strong> {{ o.threshold }}</div>
                        <div><strong>ÙØ§Ø¦Ø¶ Ø¹Ù† {{ multiplier }}Ã—:</strong> <span class="badge">{{ o.excess }}</span></div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if watchlist %}
        <div class="section watch">
            <h2>ğŸ‘€ Ù‚Ø§Ø¦Ù…Ø© Ù…ØªØ§Ø¨Ø¹Ø©</h2>
            <div class="items">
                {% for w in watchlist %}
                    <div class="item">
                        <div><strong>Ø±Ù‚Ù…:</strong> {{ w.product.product_number }}</div>
                        <div><strong>Ø§Ø³Ù…:</strong> {{ w.product.name }}</div>
                        <div><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> {{ w.warehouse }}</div>
                        <div><strong>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰:</strong> {{ w.threshold }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if counts.anomaly %}
        <div class="section overstock">
            <h2>ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø´Ø°ÙˆØ°</h2>
            <div style="margin-bottom:10px; color:#374151;">Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±: ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ± â‰¥ {{ policy.large_change_threshold }}ØŒ ØªÙƒØ±Ø§Ø± ØªØºÙŠÙŠØ±Ø§Øª Ø®Ù„Ø§Ù„ {{ policy.frequent_window_hours }} Ø³Ø§Ø¹Ø© â‰¥ {{ policy.frequent_change_min_count }}, ÙƒÙ…ÙŠØ§Øª Ø³Ø§Ù„Ø¨Ø©</div>
            {% if large_changes %}
            <div class="items">
                {% for a in large_changes %}
                    <div class="item">
                        <div><strong>Ø±Ù‚Ù…:</strong> {{ a.product_number }}</div>
                        <div><strong>ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ±:</strong> {{ a.change }}</div>
                        <div><strong>Ù‚Ø¨Ù„:</strong> {{ a.before }}</div>
                        <div><strong>Ø¨Ø¹Ø¯:</strong> {{ a.after }}</div>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if frequent_changes %}
            <div class="items">
                {% for f in frequent_changes %}
                    <div class="item">
                        <div><strong>Ø±Ù‚Ù…:</strong> {{ f.product.product_number }}</div>
                        <div><strong>Ø§Ø³Ù…:</strong> {{ f.product.name }}</div>
                        <div><strong>Ø¹Ø¯Ø¯ ØªØºÙŠÙŠØ±Ø§Øª 24 Ø³Ø§Ø¹Ø©:</strong> {{ f.count }}</div>
                        <a href="/products/{{ f.product.id }}/" class="btn" style="margin-top:8px">ÙØªØ­ Ø§Ù„Ù…Ù†ØªØ¬</a>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if negative_quantities %}
            <div class="items">
                {% for p in negative_quantities %}
                    <div class="item">
                        <div><strong>Ø±Ù‚Ù…:</strong> {{ p.product_number }}</div>
                        <div><strong>Ø§Ø³Ù…:</strong> {{ p.name }}</div>
                        <div><strong>ÙƒÙ…ÙŠØ©:</strong> {{ p.quantity }}</div>
                        <a href="/products/{{ p.id }}/" class="btn" style="margin-top:8px">ÙØªØ­ Ø§Ù„Ù…Ù†ØªØ¬</a>
                    </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <button id="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
    <div id="sidebar-overlay"></div>
    <div id="main-sidebar">
        <div class="sidebar-header">
            <h2>ğŸ§­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</h2>
            <button class="sidebar-close" onclick="toggleSidebar()">Ã—</button>
        </div>
        <div class="sidebar-search">
            <input type="text" id="sidebar-search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…..." autocomplete="off">
            <div id="sidebar-search-results"></div>
        </div>
        <div class="sidebar-content" id="sidebar-main-content">
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                <a href="/" class="sidebar-link">
                    <span class="icon">ğŸ”</span>
                    <span class="text">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                </a>
                <a href="/dashboard/" class="sidebar-link">
                    <span class="icon">ğŸ“Š</span>
                    <span class="text">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </a>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                <a href="/audit-logs/" class="sidebar-link">
                    <span class="icon">ğŸ“‹</span>
                    <span class="text">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                </a>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
                <a href="/data-quality/" class="sidebar-link">
                    <span class="icon">ğŸ› ï¸</span>
                    <span class="text">Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                </a>
                <a href="/inventory-insights/" class="sidebar-link active">
                    <span class="icon">ğŸ“¦</span>
                    <span class="text">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                </a>
            </div>
        </div>
    </div>

    <script>
    (function(){
        var mInp = document.getElementById('multiplier-input');
        var btn = document.getElementById('apply-multiplier');
        if (mInp && btn){
            mInp.addEventListener('input', function(){
                var m = parseInt(mInp.value || '2');
                if (!m || m < 1) m = 2;
                var base = window.location.pathname + '?';
                var params = new URLSearchParams(window.location.search);
                params.set('overstock_multiplier', m);
                btn.href = base + params.toString();
            });
        }
    })();
    </script>
    <script src="{% static 'js/notifications.js' %}"></script>
    <script src="{% static 'js/sidebar.js' %}"></script>
</body>
</html>