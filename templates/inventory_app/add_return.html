<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</title>
    {% load static %}
    <link rel="icon" type="image/svg+xml" href="{% static 'img/favicon.svg' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/quick_search.css' %}">
    
    <style>
        .return-form-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-width: 900px;
            margin: 0 auto;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border-right: 4px solid #10b981;
        }
        
        .form-section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #10b981;
        }
        
        .products-input {
            font-family: monospace;
            min-height: 150px;
            resize: vertical;
        }
        
        .input-hint {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }
        
        .selected-products {
            margin-top: 20px;
            padding: 15px;
            background: #dcfce7;
            border-radius: 8px;
            border: 1px solid #10b981;
        }
        
        .selected-products h4 {
            margin: 0 0 10px 0;
            color: #065f46;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-number {
            font-weight: bold;
            color: #1e293b;
            font-family: monospace;
        }
        
        .product-quantity {
            color: #10b981;
            font-weight: bold;
        }
        
        .remove-product {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .remove-product:hover {
            background: #dc2626;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .submit-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header" style="margin-bottom: 30px;">
            <h1>ğŸ”„ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</h1>
            <div>
                <a href="{% url 'inventory_app:returns_list' %}" class="btn btn-secondary">
                    <span class="btn-icon">ğŸ“‹</span>
                    Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
                </a>
                <a href="/" class="btn btn-secondary">
                    <span class="btn-icon">ğŸ </span>
                    Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
            </div>
        </div>
        
        <div class="return-form-container">
            <form id="return-form">
                {% csrf_token %}
                
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹ -->
                <div class="form-section">
                    <div class="form-section-title">
                        ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹
                    </div>
                    
                    <div class="form-group">
                        <label for="returned-by">Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ *</label>
                        <input type="text" id="returned-by" name="returned_by" required 
                               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„">
                    </div>
                    
                    <div class="form-group">
                        <label for="return-reason">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</label>
                        <input type="text" id="return-reason" name="return_reason" 
                               placeholder="Ù…Ø«Ø§Ù„: ØªØ§Ù„ÙØŒ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨ØŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨">
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                        <textarea id="notes" name="notes" rows="3" 
                                  placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© -->
                <div class="form-section">
                    <div class="form-section-title">
                        ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©
                    </div>
                    
                    <div class="form-group">
                        <label for="products-input">Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª *</label>
                        <textarea id="products-input" class="products-input" 
                                  placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©ØŒ Ø³Ø·Ø± Ù„ÙƒÙ„ Ù…Ù†ØªØ¬:&#10;BAG-001:5&#10;BAG-002:3&#10;BAG-003:10&#10;&#10;Ø£Ùˆ Ø¨Ø¯ÙˆÙ† ÙƒÙ…ÙŠØ© Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙ…ÙŠØ© ÙˆØ§Ø­Ø¯Ø©:&#10;BAG-001"></textarea>
                        <div class="input-hint">
                            ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨ØµÙŠØºØ©: <code>Ø±Ù‚Ù…_Ø§Ù„Ù…Ù†ØªØ¬:Ø§Ù„ÙƒÙ…ÙŠØ©</code> Ø£Ùˆ <code>Ø±Ù‚Ù…_Ø§Ù„Ù…Ù†ØªØ¬</code> ÙÙ‚Ø· (Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙ…ÙŠØ© ÙˆØ§Ø­Ø¯Ø©)
                        </div>
                    </div>
                    
                    <div id="selected-products-container" style="display: none;">
                        <div class="selected-products">
                            <h4>âœ… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:</h4>
                            <div id="selected-products-list"></div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submit-btn">
                    âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª
                </button>
            </form>
        </div>
    </div>
    
    
    <!-- Sidebar -->
    <button id="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
    <div id="sidebar-overlay"></div>
    <div id="main-sidebar">
        <div class="sidebar-header">
            <h2>ğŸ§­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</h2>
            <button class="sidebar-close" onclick="toggleSidebar()">Ã—</button>
        </div>
        
        <div class="sidebar-search">
            <input type="text" id="sidebar-search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…..." autocomplete="off">
            <div id="sidebar-search-results"></div>
        </div>
        
        <div class="sidebar-content" id="sidebar-main-content">
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                <a href="/" class="sidebar-link">
                    <span class="icon">ğŸ”</span>
                    <span class="text">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                </a>
                <a href="/dashboard/" class="sidebar-link">
                    <span class="icon">ğŸ“Š</span>
                    <span class="text">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                <a href="/products/" class="sidebar-link">
                    <span class="icon">ğŸ“¦</span>
                    <span class="text">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
                </a>
                <a href="/products/add/" class="sidebar-link">
                    <span class="icon">â•</span>
                    <span class="text">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</div>
                <a href="/manage/" class="sidebar-link">
                    <span class="icon">âš™ï¸</span>
                    <span class="text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</span>
                </a>
                <a href="/locations/" class="sidebar-link">
                    <span class="icon">ğŸ“</span>
                    <span class="text">Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                <a href="{% url 'inventory_app:orders_list' %}" class="sidebar-link">
                    <span class="icon">ğŸ“‹</span>
                    <span class="text">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                </a>
                <a href="{% url 'inventory_app:returns_list' %}" class="sidebar-link active">
                    <span class="icon">ğŸ”„</span>
                    <span class="text">Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</span>
                </a>
                <a href="{% url 'inventory_app:audit_logs' %}" class="sidebar-link">
                    <span class="icon">ğŸ“‹</span>
                    <span class="text">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                </a>
            </div>
        </div>
    </div>
    <script src="{% static 'js/sidebar.js' %}"></script>
    <script>
        const returnForm = document.getElementById('return-form');
        const productsInput = document.getElementById('products-input');
        const selectedProductsContainer = document.getElementById('selected-products-container');
        const selectedProductsList = document.getElementById('selected-products-list');
        const submitBtn = document.getElementById('submit-btn');
        
        let selectedProducts = [];
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ
        productsInput.addEventListener('input', function() {
            parseProductsInput();
        });
        
        function parseProductsInput() {
            const input = productsInput.value.trim();
            if (!input) {
                selectedProducts = [];
                updateSelectedProductsDisplay();
                return;
            }
            
            const lines = input.split('\n').filter(line => line.trim());
            const products = [];
            const seenNumbers = new Set();
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                let productNumber, quantity;
                
                if (trimmed.includes(':')) {
                    const parts = trimmed.split(':');
                    productNumber = parts[0].trim();
                    quantity = parseInt(parts[1].trim()) || 1;
                } else {
                    productNumber = trimmed;
                    quantity = 1; // ÙƒÙ…ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                }
                
                if (productNumber && !seenNumbers.has(productNumber)) {
                    seenNumbers.add(productNumber);
                    products.push({
                        number: productNumber,
                        quantity: quantity
                    });
                }
            }
            
            selectedProducts = products;
            updateSelectedProductsDisplay();
        }
        
        function updateSelectedProductsDisplay() {
            if (selectedProducts.length === 0) {
                selectedProductsContainer.style.display = 'none';
                submitBtn.disabled = true;
                return;
            }
            
            selectedProductsContainer.style.display = 'block';
            selectedProductsList.innerHTML = '';
            
            let totalQuantity = 0;
            
            selectedProducts.forEach((product, index) => {
                totalQuantity += product.quantity;
                
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <div class="product-info">
                        <span class="product-number">${product.number}</span>
                        <span class="product-quantity">Ã— ${product.quantity}</span>
                    </div>
                `;
                selectedProductsList.appendChild(productItem);
            });
            
            const totalItem = document.createElement('div');
            totalItem.style.cssText = 'margin-top: 10px; padding-top: 10px; border-top: 2px solid #10b981; font-weight: bold; color: #065f46;';
            totalItem.innerHTML = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª: ${totalQuantity}`;
            selectedProductsList.appendChild(totalItem);
            
            submitBtn.disabled = false;
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        returnForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (selectedProducts.length === 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹');
                return;
            }
            
            const returnedBy = document.getElementById('returned-by').value.trim();
            if (!returnedBy) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„');
                return;
            }
            
            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ù…Ù†ØªØ¬Ø§ØªØŸ\n\nØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${selectedProducts.length}\nØ§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„: ${returnedBy}`)) {
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
            
            try {
                const formData = {
                    products: selectedProducts,
                    returned_by: returnedBy,
                    return_reason: document.getElementById('return-reason').value.trim(),
                    notes: document.getElementById('notes').value.trim()
                };
                
                const response = await fetch('{% url "inventory_app:process_return" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… ${data.message}\n\nØ±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹: ${data.return_number}`);
                    window.location.href = '{% url "inventory_app:returns_list" %}';
                } else {
                    alert(`âŒ Ø®Ø·Ø£: ${data.error}`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª';
                }
            } catch (error) {
                alert(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}`);
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª';
            }
        });
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        submitBtn.disabled = true;
    </script>
</body>
</html>

